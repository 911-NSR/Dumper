name: ROM DumperX Extractor (GitHub Safe Mode)

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: 'ROM direct download link (.zip, .tgz, etc.)'
        required: true
      ROM_TYPE:
        description: 'ROM name (MIUI, HyperOS, LineageOS, etc.)'
        required: true
      TARGET_PATH:
        description: 'Optional folder or file to extract (e.g. vendor/lib/modules)'
        default: ''

jobs:
  dump:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git unzip zip p7zip-full aria2 lz4 brotli python3 python3-pip
          pip install tqdm rich
          echo "‚úÖ Environment ready"

      - name: Clone DumprX
        run: |
          git clone --depth=1 https://github.com/DumprX/DumprX.git dumprx
          cd dumprx
          chmod +x setup.sh dumper.sh
          echo "‚úÖ DumprX cloned"

      - name: Run DumprX setup (safe mode)
        run: |
          cd dumprx
          ./setup.sh || true
          echo "‚úÖ DumprX setup complete (safe mode)"

      - name: Download ROM
        run: |
          mkdir -p rom
          cd rom
          echo "üì• Downloading ROM from ${{ inputs.ROM_URL }}"
          aria2c -x16 -s16 -k1M "${{ inputs.ROM_URL }}" -o rom.zip
          ls -lh
          cd ..

      - name: Extract ROM with DumprX (safe mode)
        run: |
          ROM_PATH="$(pwd)/rom/rom.zip"
          OUTPUT_PATH="$(pwd)/output"
          mkdir -p "$OUTPUT_PATH"
          cd dumprx

          if [ -f "$ROM_PATH" ]; then
            echo "‚öôÔ∏è Extracting ROM (rootless safe mode)..."
            bash dumper.sh "$ROM_PATH" "$OUTPUT_PATH" --no-mount
            echo "‚úÖ Extraction completed"
            ls -lh "$OUTPUT_PATH"
          else
            echo "‚ùå ROM file not found: $ROM_PATH"
            exit 1
          fi

      - name: Handle output
        run: |
          OUTPUT_PATH="$(pwd)/../output"
          cd "$OUTPUT_PATH" || exit 1

          if [ -n "${{ inputs.TARGET_PATH }}" ]; then
            TARGET="${{ inputs.TARGET_PATH }}"
            echo "üéØ Extracting specific path: $TARGET"

            if [ -d "$TARGET" ] || [ -f "$TARGET" ]; then
              ZIP_NAME="${{ inputs.ROM_TYPE }}_${TARGET//\//_}.zip"
              zip -r "../../$ZIP_NAME" "$TARGET"
              echo "‚úÖ Zipped specific folder/file: $ZIP_NAME"
            else
              echo "‚ùå Path not found: $TARGET"
              exit 1
            fi
          else
            ZIP_NAME="${{ inputs.ROM_TYPE }}_full_dump.zip"
            zip -r "../../$ZIP_NAME" ./*
            echo "‚úÖ Zipped full ROM dump: $ZIP_NAME"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.ROM_TYPE }}-ROM-Dump
          path: |
            *.zip
          retention-days: 7
