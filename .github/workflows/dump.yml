name: ROM DumperX Extractor

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: 'Direct download link for ROM (.zip, .tgz, etc.) or supported website'
        required: true
      ROM_TYPE:
        description: 'ROM name (MIUI, HyperOS, LineageOS, etc.)'
        required: true
      TARGET_PATH:
        description: 'Optional folder or file to extract inside the ROM output'
        default: ''

jobs:
  dump:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git unzip zip p7zip-full aria2 lz4 brotli python3 python3-pip
          pip install tqdm rich
          echo "‚úÖ Environment ready"

      - name: Clone DumprX
        run: |
          git clone --depth=1 https://github.com/DumprX/DumprX.git dumprx
          cd dumprx
          chmod +x setup.sh dumper.sh
          echo "‚úÖ DumprX cloned"

      - name: Run DumprX setup (safe mode)
        run: |
          cd dumprx
          ./setup.sh || true
          echo "‚úÖ DumprX setup complete (safe mode)"

      - name: Download ROM inside DumprX
        run: |
          cd dumprx
          echo "üì• Downloading ROM from ${{ inputs.ROM_URL }}"
          aria2c -x16 -s16 -k1M "${{ inputs.ROM_URL }}" -o rom.zip
          ls -lh rom.zip

      - name: Extract ROM with DumprX
        run: |
          cd dumprx
          export TERM=xterm-256color
          echo "‚öôÔ∏è Extracting ROM (rootless safe mode)..."
          bash dumper.sh "rom.zip"
          echo "‚úÖ Extraction completed"

      - name: Handle output
        run: |
          # Detect DumprX output folder
          OUTPUT=dumprx/out
          cd "$OUTPUT"

          if [ -n "${{ inputs.TARGET_PATH }}" ]; then
            TARGET="${{ inputs.TARGET_PATH }}"
            echo "üéØ Extracting specific path: $TARGET"

            # Search for folder/file inside output
            FOUND=$(find . -path "./$TARGET" -type d -o -path "./$TARGET" -type f)
            if [ -z "$FOUND" ]; then
              echo "‚ùå Path not found: $TARGET"
              exit 1
            fi

            ZIP_NAME="../${{ inputs.ROM_TYPE }}_${TARGET//\//_}.zip"
            zip -r "$ZIP_NAME" $FOUND
            echo "‚úÖ Zipped specific folder/file: $ZIP_NAME"
          else
            ZIP_NAME="../${{ inputs.ROM_TYPE }}_full_dump.zip"
            zip -r "$ZIP_NAME" ./*
            echo "‚úÖ Zipped full ROM dump: $ZIP_NAME"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.ROM_TYPE }}-ROM-Dump
          path: |
            dumprx/*.zip
          retention-days: 7
          
